---
- name: Clear redfish job queues
  become: yes
  shell: podman run -it --rm quay.io/quads/badfish -H mgmt-{{ item[1].stdout }} -u quads -p {{ chassis_password }} --clear-jobs --force
  when: vendors is defined and item[0] == "dell"
  with_together:
    - "{{ vendors }}"
    - "{{ host_list.results }}"
  register: clear_jobs
  until: clear_jobs is succeeded
  retries: 3
  delay: 30

- name: Wait for iDrac to be responsive
  become: yes
  shell: podman run -it --rm quay.io/quads/badfish -H mgmt-{{ item[1].stdout }} -u quads -p {{ chassis_password }} -i config/idrac_interfaces.yml --check-boot
  when: vendors is defined and item[0] == "dell"
  with_together:
    - "{{ vendors }}"
    - "{{ host_list.results }}"
  register: wait_for_idrac
  until: wait_for_idrac is succeeded
  retries: 20
  delay: 30

- name: set boot order director (badfish)
  become: yes
  shell: podman run -it --rm quay.io/quads/badfish -H mgmt-{{ item[1].stdout }} -u quads -p {{ chassis_password }} -i config/idrac_interfaces.yml -t director
  when: vendors is defined and item[0] == "dell"
  with_together:
    - "{{ vendors }}"
    - "{{ host_list.results }}"
  retries: 5
  delay: 3
  register: result
  until: result.rc == 0

- name: power cycle overcloud nodes
  become: yes
  shell: podman run -it --rm quay.io/quads/badfish -H mgmt-{{ item[1].stdout }} -u quads -p {{ chassis_password }} --power-cycle
  when: vendors is defined and item[0] == "dell"
  with_together:
    - "{{ vendors }}"
    - "{{ host_list.results }}"

- name: Wait for iDrac to be responsive
  become: yes
  shell: podman run -it --rm quay.io/quads/badfish -H mgmt-{{ item[1].stdout }} -u quads -p {{ chassis_password }} -i config/idrac_interfaces.yml --check-boot
  when: vendors is defined and item[0] == "dell"
  with_together:
    - "{{ vendors }}"
    - "{{ host_list.results }}"
  register: wait_for_idrac
  until: wait_for_idrac is succeeded
  retries: 20
  delay: 30
